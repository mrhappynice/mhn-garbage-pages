<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>I.. Can't.. Look Away</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover">
  <style>
    html,body{height:100%;margin:0;background:#001043;}
    canvas{position:fixed;inset:0;width:100vw;height:100vh;display:block;touch-action:none}

    .warn{position:fixed;inset:auto 0 0 0;text-align:center;color:#fff;font:14px/1.4 system-ui,Arial;padding:.5rem;background:#0008}

    /* --- Minimal glassy controls --- */
    .controls{
      position:fixed;
      right: max(12px, env(safe-area-inset-right));
      bottom: max(12px, env(safe-area-inset-bottom));
      z-index:10;
      user-select:none;
      display:flex;
      align-items:center;
      gap:.6rem;
      padding:.6rem .7rem;
      border:1px solid rgba(255,255,255,.2);
      background: rgba(0,0,0,.28);
      backdrop-filter: saturate(160%) blur(8px);
      border-radius: 14px;
    }
    .ctrl-btn{
      -webkit-tap-highlight-color: transparent;
      width:42px; height:42px; border-radius:999px;
      border:1px solid rgba(255,255,255,.25);
      background: rgba(255,255,255,.06);
      display:grid; place-items:center;
      cursor:pointer; outline:none;
      transition: transform .15s ease, opacity .15s ease, background .15s ease;
      opacity:.9;
    }
    .ctrl-btn:hover{ opacity:1; transform:translateY(-1px); }
    .ctrl-btn:active{ transform:translateY(0); }
    .ctrl-btn:focus-visible{ box-shadow:0 0 0 3px rgba(255,255,255,.35); }
    .ctrl-btn svg{ width:20px; height:20px; fill:#fff; }

    .slider-wrap{
      display:flex; align-items:center; gap:.6rem; min-width: 220px;
    }
    .speed-value{ color:#fff; font:12px/1 system-ui,Arial; opacity:.85; min-width:3.2em; text-align:center; }

    /* Range input styled as a glassy, dual-sided track */
    .speed{
      -webkit-appearance: none; appearance: none;
      height: 6px; width: 240px; max-width: 36vw;
      background: linear-gradient(90deg, #fff6 0 50%, #fff8 50% 50%, #fff6 50% 100%);
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.25);
      outline: none; position:relative;
    }
    .speed::-webkit-slider-thumb{
      -webkit-appearance: none;
      width: 18px; height: 18px; border-radius: 50%;
      background: #fff; border: none; box-shadow: 0 2px 8px #0006;
      cursor: pointer;
    }
    .speed::-moz-range-thumb{
      width: 18px; height: 18px; border-radius: 50%;
      background: #fff; border: none; box-shadow: 0 2px 8px #0006;
      cursor: pointer;
    }

    /* compact on very small screens */
    @media (max-height: 520px){
      .controls{ padding:.45rem .55rem; gap:.45rem; }
      .ctrl-btn{ width:38px; height:38px; }
      .ctrl-btn svg{ width:18px; height:18px; }
      .speed{ width: 200px; }
    }
  </style>
</head>
<body>
<canvas id="c"></canvas>
<div id="warn" class="warn" hidden>icla</div>

<!-- Overlay controls -->
<div class="controls" aria-label="Playback controls">
  <button class="ctrl-btn" id="playPause" aria-label="Play / Pause" title="Play / Pause">
    <!-- starts in Play state if we load paused=false -->
    <svg id="playPauseIcon" viewBox="0 0 24 24" aria-hidden="true">
      <!-- pause icon (default, since we start playing) -->
      <path d="M6 5h4v14H6zM14 5h4v14h-4z"/>
    </svg>
  </button>

  <div class="slider-wrap">
    <input id="speed" class="speed" type="range" min="-4" max="4" step="0.1" value="1" aria-label="Playback speed: left rewinds, right fast-forwards">
    <div id="speedVal" class="speed-value">1.0×</div>
  </div>

  <button class="ctrl-btn" id="normal" aria-label="Normal speed" title="Set to normal speed (1×)">
    <!-- target/center icon -->
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M12 8a4 4 0 104 4 4 4 0 00-4-4zm9 3h-2.07a7.94 7.94 0 00-1.73-4.2l1.46-1.46-1.41-1.41-1.46 1.46A7.94 7.94 0 0013 3.07V1h-2v2.07a7.94 7.94 0 00-4.2 1.73L5.34 3.34 3.93 4.75l1.46 1.46A7.94 7.94 0 003.07 11H1v2h2.07a7.94 7.94 0 001.73 4.2L3.34 18.66l1.41 1.41 1.46-1.46A7.94 7.94 0 0011 20.93V23h2v-2.07a7.94 7.94 0 004.2-1.73l1.46 1.46 1.41-1.41-1.46-1.46A7.94 7.94 0 0020.93 13H23v-2z"/>
    </svg>
  </button>
</div>

<script>
const canvas = document.getElementById('c');
const warnEl  = document.getElementById('warn');

// --- WebGL init (try WebGL2, then WebGL1) ---------------------------------
let gl = canvas.getContext('webgl2', {antialias:false, alpha:false, desynchronized:true});
let glVersion = 2;
if (!gl) { gl = canvas.getContext('webgl', {antialias:false, alpha:false, desynchronized:true}); glVersion = 1; }
if (!gl) { warnEl.hidden = false; throw new Error('No WebGL'); }

// --- Fullscreen DPR sizing -------------------------------------------------
function fit() {
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const w = Math.floor(innerWidth * dpr);
  const h = Math.floor(innerHeight * dpr);
  if (canvas.width !== w || canvas.height !== h) {
    canvas.width = w; canvas.height = h;
  }
  gl.viewport(0, 0, canvas.width, canvas.height);
}
addEventListener('resize', fit);
fit();

// --- Shader sources --------------------------------------------------------
const MAX_IMPULSES = 8;
const commonUniforms = `
uniform vec2  u_res;
uniform float u_time;
uniform int   u_impCount;
uniform vec2  u_impPos[${MAX_IMPULSES}];
uniform vec3  u_impPar[${MAX_IMPULSES}];
`;

const vs_src = glVersion === 2 ? `#version 300 es
in vec2 a_pos;
out vec2 v_uv;
void main(){ v_uv = (a_pos + 1.0) * 0.5; gl_Position = vec4(a_pos, 0.0, 1.0); }`
:
`attribute vec2 a_pos;
varying vec2 v_uv;
void main(){ v_uv = (a_pos + 1.0) * 0.5; gl_Position = vec4(a_pos, 0.0, 1.0); }`;

const fs_src = (glVersion === 2 ? `#version 300 es
precision highp float;
in vec2 v_uv;
out vec4 fragColor;` : `precision highp float; varying vec2 v_uv;`)
+ commonUniforms + `
vec2 applyImpulses(vec2 p) {
  for (int i=0; i<${MAX_IMPULSES}; ++i) {
    if (i >= u_impCount) break;
    vec2  c = u_impPos[i];
    vec2  d = p - c;
    float r2 = dot(d,d);
    float strength = u_impPar[i].x;
    float sigma    = max(0.0001, u_impPar[i].y);
    float decay    = u_impPar[i].z;
    float w = exp(-r2 / (2.0*sigma*sigma)) * decay;
    vec2 radial = d * strength * w;
    vec2 swirl = vec2(-d.y, d.x) * (0.35 * strength * w);
    p += radial + swirl;
  }
  return p;
}
void main(){
  vec2 p = v_uv * 2.0 - 1.0;
  p = applyImpulses(p);
  float s = 0.5 * min(u_res.x, u_res.y);
  float px = (p.x * u_res.x * 0.5) / s;
  float py = (p.y * u_res.y * 0.5) / s;
  float cx = -0.8  + 0.20 * sin(u_time * 0.20);
  float cy =  0.156 + 0.20 * cos(u_time * 0.15);
  const int MAX_ITER = 1234;
  float x = px, y = py;
  float D = 100.0;
  for (int k=0; k<MAX_ITER; ++k) {
    float x2 = x*x, y2 = y*y;
    if (x2 + y2 > 4.0) break;
    float T = x2 - y2;
    y = 2.0*x*y + cy;
    x = T + cx;
    D = min(D, min(abs(x), abs(y)));
  }
  vec3 bg  = vec3(0.0, 0.0627, 0.2627);
  vec3 ink = vec3(1.0, 0.980, 0.627);
  vec3 col = mix(bg, ink, step(D, 0.01));
  ${glVersion === 2 ? `fragColor = vec4(col, 1.0);` : `gl_FragColor = vec4(col, 1.0);`}
}`;

// --- Compile & link --------------------------------------------------------
function compile(type, src){
  const sh = gl.createShader(type); gl.shaderSource(sh, src); gl.compileShader(sh);
  if (!gl.getShaderParameter(sh, gl.COMPILE_STATUS)) { console.error(gl.getShaderInfoLog(sh), src); throw new Error('Shader compile error'); }
  return sh;
}
function program(vs, fs){
  const p = gl.createProgram(); gl.attachShader(p, vs); gl.attachShader(p, fs); gl.linkProgram(p);
  if (!gl.getProgramParameter(p, gl.LINK_STATUS)) { console.error(gl.getProgramInfoLog(p)); throw new Error('Program link error'); }
  return p;
}
const prog = program(compile(gl.VERTEX_SHADER, vs_src), compile(gl.FRAGMENT_SHADER, fs_src));
gl.useProgram(prog);

// fullscreen triangle
const quad = gl.createBuffer();
gl.bindBuffer(gl.ARRAY_BUFFER, quad);
gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([ -1,-1,  3,-1,  -1,3 ]), gl.STATIC_DRAW);
const loc_pos = gl.getAttribLocation(prog, 'a_pos');
gl.enableVertexAttribArray(loc_pos);
gl.vertexAttribPointer(loc_pos, 2, gl.FLOAT, false, 0, 0);

// uniforms
const u_res      = gl.getUniformLocation(prog, 'u_res');
const u_time     = gl.getUniformLocation(prog, 'u_time');
const u_impCount = gl.getUniformLocation(prog, 'u_impCount');
const u_impPos   = gl.getUniformLocation(prog, 'u_impPos[0]');
const u_impPar   = gl.getUniformLocation(prog, 'u_impPar[0]');

// --- Interaction: impulses -------------------------------------------------
const MAX_IMPULSES_JS = 8;
const impulses = []; // {xN, yN, t0, strength, sigma, tau}

// --- Virtual time & transport ---------------------------------------------
let virtualTime = 0;     // seconds
let lastRafMs = null;    // ms timestamp from RAF

let isPaused = false;    // play/pause state
let sliderSpeed = 1.0;   // signed speed from slider (-4..4)
let timeSpeed = 1.0;     // effective speed (0 if paused)

function refreshTimeSpeed(){
  timeSpeed = isPaused ? 0 : sliderSpeed;
  // icon swap
  playPauseIcon.innerHTML = isPaused
    ? '<path d="M8 5v14l11-7z"/>'             // play icon
    : '<path d="M6 5h4v14H6zM14 5h4v14h-4z"/>';// pause icon
}

// --- UI wiring -------------------------------------------------------------
const inputSpeed = document.getElementById('speed');
const speedVal   = document.getElementById('speedVal');
const btnPlay    = document.getElementById('playPause');
const playPauseIcon = document.getElementById('playPauseIcon');
const btnNormal  = document.getElementById('normal');

// initialize UI
function updateSpeedLabel(v){
  const s = Number(v);
  if (s === 0) { speedVal.textContent = '0×'; return; }
  const dir = s > 0 ? '' : '−';
  speedVal.textContent = (s>0? s : -s).toFixed(1) + '×' + (s<0 ? ' RW' : '');
}
updateSpeedLabel(inputSpeed.value);

// slider input
inputSpeed.addEventListener('input', (e)=>{
  sliderSpeed = Number(e.target.value);
  updateSpeedLabel(sliderSpeed);
  refreshTimeSpeed();
});

// play/pause toggle
btnPlay.addEventListener('click', ()=>{
  isPaused = !isPaused;
  refreshTimeSpeed();
});

// normal speed button
btnNormal.addEventListener('click', ()=>{
  sliderSpeed = 1.0;
  inputSpeed.value = '1';
  updateSpeedLabel(1);
  refreshTimeSpeed();
});

// keyboard: space toggles pause; arrows nudge speed; 0 sets stop; 1 sets normal
addEventListener('keydown', (e)=>{
  if (e.key === ' '){ e.preventDefault(); isPaused = !isPaused; refreshTimeSpeed(); }
  else if (e.key === 'ArrowRight'){ sliderSpeed = Math.min(4, sliderSpeed + 0.1); inputSpeed.value = String(sliderSpeed); updateSpeedLabel(sliderSpeed); refreshTimeSpeed(); }
  else if (e.key === 'ArrowLeft'){  sliderSpeed = Math.max(-4, sliderSpeed - 0.1); inputSpeed.value = String(sliderSpeed); updateSpeedLabel(sliderSpeed); refreshTimeSpeed(); }
  else if (e.key === '0'){ sliderSpeed = 0; inputSpeed.value = '0'; updateSpeedLabel(0); refreshTimeSpeed(); }
  else if (e.key === '1'){ sliderSpeed = 1; inputSpeed.value = '1'; updateSpeedLabel(1); refreshTimeSpeed(); }
});

// --- Pointer impulses ------------------------------------------------------
function addImpulse(clientX, clientY){
  const xN = (clientX / innerWidth) * 2 - 1;
  const yN = (clientY / innerHeight) * 2 - 1;
  impulses.push({ xN, yN, t0: virtualTime, strength: 0.75, sigma: 0.22, tau: 1.6 });
  if (impulses.length > MAX_IMPULSES_JS) impulses.shift();
}
canvas.addEventListener('pointerdown', e => { e.preventDefault(); addImpulse(e.clientX, e.clientY); });

// --- Render loop -----------------------------------------------------------
function frame(tMs){
  if (lastRafMs == null) lastRafMs = tMs;
  const dt = Math.max(0, (tMs - lastRafMs) * 0.001);
  lastRafMs = tMs;

  virtualTime += dt * timeSpeed;

  gl.uniform2f(u_res, canvas.width, canvas.height);
  gl.uniform1f(u_time, virtualTime);

  const pos = new Float32Array(8 * 2);
  const par = new Float32Array(8 * 3);
  let count = 0;
  for (let m of impulses) {
    const age = virtualTime - m.t0;
    const decay = Math.exp(-Math.max(0, age) / m.tau);
    if (decay <= 0.02) continue;
    if (count >= 8) break;
    pos[count*2+0] = m.xN;
    pos[count*2+1] = m.yN;
    par[count*3+0] = m.strength;
    par[count*3+1] = m.sigma;
    par[count*3+2] = decay;
    count++;
  }
  gl.uniform1i(u_impCount, count);
  if (count > 0) {
    gl.uniform2fv(u_impPos, pos);
    gl.uniform3fv(u_impPar, par);
  }

  gl.drawArrays(gl.TRIANGLES, 0, 3);
  requestAnimationFrame(frame);
}
refreshTimeSpeed(); // set initial icon & speed
requestAnimationFrame(frame);
</script>
</body>
</html>
